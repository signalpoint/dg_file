dg.createModule("dg_file"),dg_file._fileWidgets={},dg_file.getFileWidget=function(e){return dg_file._fileWidgets[e]?dg_file._fileWidgets[e]:null},dg_file.setFileWidget=function(e,i){dg_file._fileWidgets[e]=i},dg_file._fileInputs={},dg_file.getFileInput=function(e){return dg_file._fileInputs[e]?dg_file._fileInputs[e]:null},dg_file.setFileInput=function(e){dg_file._fileInputs[e.id()]=e},dg.FileElement=function(e,i,t){dg.FormElementPrepare(this,arguments)},dg.FileElement.prototype=new dg.FormElement,dg.FileElement.prototype.constructor=dg.FileElement,DgFileInput=function(e){this._variables=e;var i=this._variables._attributes;i.id||(i.id="dg-file-widget-"+dg.salt());var t=i.id;this._id=t,this._wrapperId=t+"-wrapper",this._previewId=t+"-preview",this._formInputId=e._formInputId},DgFileInput.prototype.id=function(){return this._id},DgFileInput.prototype.getVars=function(){return this._variables},DgFileInput.prototype.getAttributes=function(){return this.getVars()._attributes},DgFileInput.prototype.getWrapperId=function(){return this._wrapperId},DgFileInput.prototype.getPreviewId=function(){return this._previewId},DgFileInput.prototype.getFormInputId=function(){return this._formInputId},DgFileInput.prototype.getInput=function(){return dg.qs("#"+this.id())},DgFileInput.prototype.html=function(){var e=this.getWrapperId(),i='<div id="'+e+'" class="dg-file-widget-wrapper">',t=this.getPreviewId(),n=(this.getFormInputId(),null),d=this.getAttributes(),l=this.id();dg.isCompiled()?(d.onclick="dg_file.openFilePicker('"+l+"')",d.class.push("dg-file-choose-file"),n=dg.b(dg.t("Choose File"),{_attributes:d})+dg.b(dg.t("Take Picture"),{_attributes:{id:l+"-camera",class:["dg-file-take-picture"],onclick:"dg_file.openCamera('"+l+"')"}})):(d.type||(d.type="file"),d.onchange||(d.onchange="dg_file.chooseFileOnchange('"+l+"')"),d.class.push("dg-file-widget"),n="<input "+dg.attributes(d)+"/>");var r={id:t,src:"",class:["dg-file-preview"]},g="<img "+dg.attributes(r)+">";return i+=n+g,i+"</div>"},DgFileInput.prototype.hideInput=function(){dg.hide(this.getInput());var e=dg.qs("#"+this.id()+"-camera");e&&dg.hide(e)},DgFileInput.prototype.setPreview=function(e){var i=dg.qs("#"+this.getPreviewId());i.src=e,i.height=64},DgFileInput.prototype.getMessageBox=function(){return dg.qs("#dg-file-form-messages")},DgFileInput.prototype.setMessage=function(e,i){this.getMessageBox().innerHTML=dg.render({_theme:"message",_type:i?i:"status",_message:e})},DgFileInput.prototype.clearMessage=function(e,i){this.getMessageBox().innerHTML=""},dg_file.setOptions=function(e){return{quality:100,destinationType:Camera.DestinationType.FILE_URI,sourceType:e,encodingType:Camera.EncodingType.JPEG,mediaType:Camera.MediaType.PICTURE,allowEdit:!1,correctOrientation:!0}},dg_file.encodeImageUri=function(e){return new Promise(function(i,t){var n=document.createElement("canvas"),d=n.getContext("2d"),l=new Image;l.onload=function(){n.width=this.width,n.height=this.height,d.drawImage(l,0,0),i(n.toDataURL("image/jpeg"))},l.src=dg_file.cleanUri(e)})},dg_file.openCamera=function(e){var i=Camera.PictureSourceType.CAMERA,n=dg_file.setOptions(i),d=function(e){cw_app.error(null,null,e)};navigator.camera.getPicture(function(i){window.resolveLocalFileSystemURL(i,function(t){t.file(function(t){dg_file.loaded(t,i,e)})},function(){d(t("Unable to get picture from local file system."))})},d,n)},dg_file.cleanUri=function(e){return"ios"==dg.platform()?window.WkWebView.convertFilePath(e):e},dg_file.loaded=function(e,i,t){var n=dg.isCompiled(),d=dg_file.getFileInput(t),l=d.getFormInputId(),r=dg_file.getFileWidget(l),g=function(t){0===t.indexOf("data:image")&&(t=t.substring(t.indexOf(",")+1));var n=e.name,g="public://",o=r._filePathDir;o&&(g+=o+"/"),g+=n;var s={file:t,filename:n,filepath:g};d.hideInput(),d.setMessage(dg.t("Uploading")+"..."),file_save(s,{success:function(e){e.fid?(dg.qs("#"+l).value=e.fid,d.clearMessage(),i=dg_file.cleanUri(i),d.setPreview(i)):dg.error(null,null,dg.t("There was a problem saving the file."))},error:function(e,i,t){d.setMessage(t,"error")}})};n?dg_file.encodeImageUri(i).then(function(e){g(e)}):g(i)},dg_file.parseFid=function(e){return parseInt(e)},dg_file.getFileElementNamesFromForm=function(e){var i=[];if(e.elements)for(var t in e.elements)if(e.elements.hasOwnProperty(t)){var n=e.elements[t];if(n.type&&"file"==n.type){i.push(t);break}}return i.length?i:null},dg_file._pendingFileIds=[],dg_file.getPendingFileIds=function(){return dg_file._pendingFileIds},dg_file.setPendingFileIds=function(e){dg_file._pendingFileIds=e},dg_file.hasPendingFileIds=function(){return dg_file.getPendingFileIds().length},dg_file.isPendingFileId=function(e){return in_array(dg_file.parseFid(e),dg_file.getPendingFileIds())},dg_file.addToPendingFileIds=function(e){e=dg_file.parseFid(e),dg_file.isPendingFileId(e)||dg_file.getPendingFileIds().push(e)},dg_file.removeFromPendingFileIds=function(e){e=dg_file.parseFid(e);var i=dg_file.getPendingFileIds();i=i.filter(function(i){return i!==e}),dg_file.setPendingFileIds(i)},dg_file.read=function(e){},dg.theme_file_input=function(e){var i=new DgFileInput(e);return dg_file.setFileInput(i),i.html()},dg_file.chooseFileOnchange=function(e){var i=dg_file.getFileInput(e),t=i.getInput(),n=t.files[0];if(n){var d=new FileReader;d.addEventListener("load",function(){dg_file.loaded(n,d.result,e)},!1),n&&d.readAsDataURL(n)}},dg_file.openFilePicker=function(e){var i=Camera.PictureSourceType.SAVEDPHOTOALBUM,t=dg_file.setOptions(i);navigator.camera.getPicture(function(i){window.resolveLocalFileSystemURI(i,function(t){t.file(function(t){dg_file.loaded(t,i,e)})},function(){})},function(e){console.debug("Unable to obtain picture: "+e,"app")},t)},dg_file.widgetRemoveOnclick=function(e){var i=e.getAttribute("data-fid"),t=function(e,i,t){dg.alert(t)};file_delete(i,{success:function(e){console.log(e),e[0]||t(null,null,dg.t("There was a problem removing the file."))},error:t})},dg.theme_file=function(e){var i=e._attributes;i.id||(i.id="file-"+dg.salt());var t=i.id;return dg_file.setFileWidget(t,e),i.type="hidden","<input "+dg.attrs(e)+" />"+dg.render({_prefix:'<div id="dg-file-form-messages"></div>',_theme:"file_input",_formInputId:t})};